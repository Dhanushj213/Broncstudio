[{"filePath":"/Users/dhanushj/Desktop/Broncstudio/src/app/collections/[slug]/page.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'result' is never reassigned. Use 'const' instead.","line":164,"column":13,"nodeType":"Identifier","messageId":"useConst","endLine":164,"endColumn":19,"fix":{"range":[6619,6646],"text":"const result = [...products];"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useEffect, useState, useMemo } from 'react';\nimport Link from 'next/link';\nimport { useParams } from 'next/navigation';\nimport GlassCard from '@/components/UI/GlassCard';\nimport AmbientBackground from '@/components/UI/AmbientBackground';\nimport { motion } from 'framer-motion';\nimport ProductCard from '@/components/Product/ProductCard';\nimport { createClient } from '@/utils/supabase/client';\nimport { LayoutGrid } from 'lucide-react';\nimport BrandLoader from '@/components/UI/BrandLoader';\nimport { FLAT_TAXONOMY, FlatNode } from '@/data/flatTaxonomy';\nimport SortBar, { SortOption } from '@/components/Collection/SortBar';\nimport TabbedProductShowcase from '@/components/Home/TabbedProductShowcase';\nimport { DBProduct, TaxonomyCategory, TaxonomySubcategory, TaxonomyItem } from '@/types/shop';\n\n// This page handles ALL levels: World, Category, and Leaf Item\nexport default function CollectionPage() {\n    const params = useParams();\n    const slug = params?.slug as string;\n\n    const [node, setNode] = useState<FlatNode | null>(null);\n    const [products, setProducts] = useState<DBProduct[]>([]);\n    const [loading, setLoading] = useState(true);\n\n    const [sortOption, setSortOption] = useState<SortOption>('featured');\n\n    const supabase = useMemo(() => createClient(), []);\n\n    // 1. Resolve Node from Flat Taxonomy OR Curated DB\n    useEffect(() => {\n        if (!slug) return;\n\n        const resolveData = async () => {\n            // A. Check Flat Taxonomy (Static)\n            const foundNode = FLAT_TAXONOMY[slug];\n            if (foundNode) {\n                setNode(foundNode);\n                setLoading(false);\n                return;\n            }\n\n            // B. Check Curated Collections (Dynamic DB)\n            // GUID Regex or just try fetching\n            if (slug.length > 20) { // Simple heuristic for UUID-like length\n                const { data: section } = await supabase\n                    .from('curated_sections')\n                    .select('*')\n                    .eq('id', slug)\n                    .single();\n\n                if (section) {\n                    setNode({\n                        type: 'curated',\n                        data: {\n                            name: section.title,\n                            slug: section.id, // Use ID as slug for internal logic\n                            description: section.description,\n                            image: section.image_url,\n                            items: []\n                        },\n                        parent: { name: 'Collections', slug: '' }\n                    });\n                    setLoading(false);\n                    return;\n                }\n            }\n\n            setNode(null);\n            setLoading(false);\n        };\n\n        resolveData();\n    }, [slug, supabase]);\n\n    // 2. Fetch Products\n    useEffect(() => {\n        const fetchProducts = async () => {\n            if (!node) return;\n\n            setLoading(true);\n\n            // Case A: Curated Collection\n            if (node.type === 'curated') {\n                // Fetch ALL products (optimized select) then filter in memory/JS for reliability with JSON arrays\n                const { data, error } = await supabase\n                    .from('products')\n                    .select('id, name, price, compare_at_price, images, stock_status, created_at, category_id, metadata');\n\n                if (error) {\n                    console.error(\"Error fetching products:\", error);\n                } else if (data) {\n                    // Filter where curated_section_ids includes our slug\n                    const filtered = data.filter((p: DBProduct) => {\n                        const metadata = p.metadata as { curated_section_ids?: string[] };\n                        return metadata?.curated_section_ids?.includes((node.data as { slug: string }).slug);\n                    });\n                    setProducts(filtered);\n                }\n                setLoading(false);\n                return;\n            }\n\n            // Case C: Standard Category/Item\n            if (node.type === 'item' || node.type === 'category') {\n                const targetSlug = node.data.slug;\n\n                // Fetch the main category (World/Level 1)\n                const { data: catData } = await supabase\n                    .from('categories')\n                    .select('*, children:categories(*)') // Self-join for immediate children\n                    .eq('slug', targetSlug)\n                    .single();\n\n                if (!catData) {\n                    setLoading(false);\n                    return;\n                }\n\n                let productQuery = supabase.from('products').select('id, name, price, compare_at_price, images, stock_status, created_at, category_id');\n\n                if (node.type === 'item') {\n                    // Leaf: Direct match\n                    productQuery = productQuery.eq('category_id', catData.id);\n                } else {\n                    // Category: Match children items\n                    const childSlugs = (node.data as TaxonomySubcategory).items?.map((i: TaxonomyItem) => i.slug) || [];\n                    if (childSlugs.length > 0) {\n                        const { data: childrenCats } = await supabase\n                            .from('categories')\n                            .select('id')\n                            .in('slug', childSlugs);\n\n                        if (childrenCats && childrenCats.length > 0) {\n                            const ids = childrenCats.map((c: { id: string }) => c.id);\n                            ids.push(catData.id);\n                            productQuery = productQuery.in('category_id', ids);\n                        } else {\n                            productQuery = productQuery.eq('category_id', catData.id);\n                        }\n                    } else {\n                        productQuery = productQuery.eq('category_id', catData.id);\n                    }\n                }\n\n                const { data, error } = await productQuery;\n                if (error) console.error(\"Error fetching products:\", error);\n\n                setProducts(data || []);\n                setLoading(false);\n            } else if (node.type === 'world') {\n                // Worlds show TabbedProductShowcase, no direct product fetch needed\n                setProducts([]);\n                setLoading(false);\n            }\n        };\n\n        fetchProducts();\n    }, [node, supabase]);\n\n    // 3. Client-Side Filtering & Sorting\n    const filteredProducts = useMemo(() => {\n        let result = [...products];\n\n        // Sort\n        switch (sortOption) {\n            case 'price-asc':\n                result.sort((a, b) => a.price - b.price);\n                break;\n            case 'price-desc':\n                result.sort((a, b) => b.price - a.price);\n                break;\n            case 'alpha-asc':\n                result.sort((a, b) => a.name.localeCompare(b.name));\n                break;\n            case 'alpha-desc':\n                result.sort((a, b) => b.name.localeCompare(a.name));\n                break;\n            case 'newest':\n                result.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());\n                break;\n            default: // featured\n                break;\n        }\n\n        return result;\n    }, [products, sortOption]);\n\n\n    if (loading) return <BrandLoader text=\"Loading Collection...\" />;\n\n    if (!node) {\n        return (\n            <div className=\"min-h-screen pt-[var(--header-height)] flex items-center justify-center bg-background\">\n                <div className=\"text-center\">\n                    <h2 className=\"text-3xl font-heading font-bold text-primary mb-2\">Collection Not Found</h2>\n                    <Link href=\"/\" className=\"px-6 py-3 bg-black dark:bg-white text-white dark:text-black rounded-full font-bold hover:bg-coral-500 transition-all inline-block mt-4\">\n                        Return Home\n                    </Link>\n                </div>\n            </div>\n        );\n    }\n\n    // Determine content type\n    let children: TaxonomySubcategory[] | TaxonomyItem[] = [];\n    if (node.type === 'world') {\n        children = (node.data as TaxonomyCategory).subcategories || [];\n    } else if (node.type === 'category') {\n        children = (node.data as TaxonomySubcategory).items || [];\n    }\n\n    const showCards = children.length > 0;\n    const showProducts = node.type === 'item' || node.type === 'category'; // 'category' can show both subs and products ideally, but sticking to logic\n\n    // Dynamic Gradient\n    const heroGradient = node.type === 'world'\n        ? 'from-blue-500/10 via-purple-500/5 to-coral-500/10'\n        : 'from-emerald-500/10 via-teal-500/5 to-blue-500/10';\n\n    return (\n        <div className=\"relative min-h-screen bg-background pt-[120px] -mt-[120px] pb-20 overflow-hidden\">\n            <AmbientBackground />\n\n\n\n            {/* Background Blob (Retained for color tint) */}\n            <div className={`absolute top-0 left-0 right-0 h-[500px] bg-gradient-to-br ${heroGradient} blur-3xl opacity-40 pointer-events-none z-0`} />\n\n            {/* Breadcrumbs */}\n            <div className=\"relative z-40 px-6 py-4 container-premium mx-auto\">\n                <div className=\"text-xs font-bold uppercase tracking-wider text-secondary flex items-center gap-2\">\n                    <Link href=\"/\" className=\"hover:text-coral-500 transition-colors\">Home</Link>\n                    <span>/</span>\n                    {node.parent && (\n                        <>\n                            <Link href={`/collections/${node.parent.slug}`} className=\"hover:text-coral-500 transition-colors\">{node.parent.name}</Link>\n                            <span>/</span>\n                        </>\n                    )}\n                    <span className=\"text-primary\">{(node.data as { name: string }).name}</span>\n                </div>\n            </div>\n\n            {/* Special Layout for World Categories (Everyday Icons, Little Legends, etc.) */}\n            {node.type === 'world' ? (\n                <div className=\"-mt-12\">\n                    <TabbedProductShowcase categorySlug={slug} />\n                </div>\n            ) : (\n                <>\n                    {/* STANDARD HERO TITLE REMOVED - Visualizing only Breadcrumbs */}\n                    <div className=\"mb-4\"></div>\n\n                    {/* STANDARD CONTENT AREA */}\n                    <div className=\"container-premium mx-auto px-4 md:px-6\">\n\n                        {/* 1. Sub-Collection Cards (Standard) */}\n                        {showCards && !showProducts && (\n                            <motion.div\n                                initial={{ opacity: 0 }}\n                                animate={{ opacity: 1 }}\n                                className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6\"\n                            >\n                                {children.map((child, idx: number) => (\n                                    <Link key={idx} href={`/collections/${child.slug}`}>\n                                        <GlassCard className=\"p-8 h-full flex flex-col items-center justify-center text-center hover:border-coral-500/30 transition-colors\">\n                                            <LayoutGrid size={32} className=\"text-coral-500 mb-4\" />\n                                            <h3 className=\"text-xl font-bold text-primary\">{child.name}</h3>\n                                            <p className=\"text-sm text-secondary mt-2\">{child.description}</p>\n                                        </GlassCard>\n                                    </Link>\n                                ))}\n                            </motion.div>\n                        )}\n\n                        {/* 2. Products with Sidebar */}\n                        {showProducts && (\n                            <div className=\"flex gap-8 lg:gap-12 relative items-start\">\n                                {/* Category Sidebar (Restored) */}\n                                <aside className=\"hidden lg:block w-64 flex-shrink-0 sticky top-24\">\n                                    <div className=\"border-r border-subtle pr-6 min-h-[50vh]\">\n                                        <h3 className=\"font-bold mb-6 uppercase text-xs tracking-wider text-secondary\">\n                                            {node.type === 'item' ? node.parent?.name || 'More in this collection' : 'Categories'}\n                                        </h3>\n                                        <div className=\"space-y-1\">\n                                            {(() => {\n                                                // Determine Sidebar Items\n                                                let sidebarItems: TaxonomyItem[] = [];\n                                                let parentSlug = slug;\n\n                                                if (node.type === 'category') {\n                                                    sidebarItems = (node.data as TaxonomySubcategory).items || [];\n                                                    parentSlug = slug;\n                                                } else if (node.type === 'item' && node.parent?.slug) {\n                                                    const parentNode = FLAT_TAXONOMY[node.parent.slug];\n                                                    sidebarItems = (parentNode?.data as TaxonomySubcategory)?.items || [];\n                                                    parentSlug = node.parent.slug;\n                                                }\n\n                                                return (\n                                                    <>\n                                                        <Link\n                                                            href={`/collections/${parentSlug}`}\n                                                            className={`block py-2 text-sm font-medium transition-colors ${slug === parentSlug\n                                                                ? 'text-coral-500 translate-x-1 font-bold'\n                                                                : 'text-secondary hover:text-coral-500 hover:translate-x-1'\n                                                                }`}\n                                                        >\n                                                            All Products\n                                                        </Link>\n\n                                                        {sidebarItems.map((item) => {\n                                                            const isActive = slug === item.slug;\n                                                            return (\n                                                                <Link\n                                                                    key={item.slug}\n                                                                    href={`/collections/${item.slug}`}\n                                                                    className={`block py-2 text-sm font-medium transition-colors ${isActive\n                                                                        ? 'text-coral-500 translate-x-1'\n                                                                        : 'text-secondary hover:text-coral-500 hover:translate-x-1'\n                                                                        }`}\n                                                                >\n                                                                    {item.name}\n                                                                </Link>\n                                                            );\n                                                        })}\n                                                    </>\n                                                );\n                                            })()}\n                                        </div>\n                                    </div>\n                                </aside>\n\n                                {/* Sort Bar & Grid Only (Filters Removed) */}\n                                <div className=\"flex-1 w-full\">\n                                    <SortBar\n                                        totalProducts={filteredProducts.length}\n                                        sortOption={sortOption}\n                                        onSortChange={setSortOption}\n                                    />\n                                    {/* ActiveFilters removed as there are no filters */}\n\n                                    {filteredProducts.length > 0 ? (\n                                        <motion.div\n                                            layout\n                                            className=\"grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-10 md:gap-x-6 lg:gap-x-8\"\n                                        >\n                                            {filteredProducts.map((product) => (\n                                                <motion.div layout key={product.id}>\n                                                    <ProductCard\n                                                        id={product.id}\n                                                        name={product.name}\n                                                        price={product.price}\n                                                        originalPrice={product.compare_at_price}\n                                                        image={product.images?.[0] || product.image_url || '/images/placeholder.jpg'}\n                                                        secondaryImage={product.images?.[1]}\n                                                        badge={product.stock_status === 'out_of_stock' ? 'Sold Out' : undefined}\n                                                    />\n                                                </motion.div>\n                                            ))}\n                                        </motion.div>\n                                    ) : (\n                                        <div className=\"py-20 text-center text-secondary\">\n                                            <h3 className=\"text-xl font-bold\">No products found</h3>\n                                        </div>\n                                    )}\n                                </div>\n                            </div>\n                        )}\n                    </div>\n                </>\n            )}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/dhanushj/Desktop/Broncstudio/src/app/shop/[[...slug]]/ShopClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LayoutGrid' is defined but never used.","line":12,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"LayoutGrid"},"fix":{"range":[479,490],"text":""},"desc":"Remove unused variable \"LayoutGrid\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Filter' is defined but never used.","line":12,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":28,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Filter"},"fix":{"range":[470,520],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatPrice' is assigned a value but never used.","line":22,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setActiveFilters' is assigned a value but never used.","line":39,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'shopHeroConfig' is assigned a value but never used.","line":46,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":26},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/dhanushj/Desktop/Broncstudio/src/app/shop/[[...slug]]/ShopClient.tsx:52:9\n  50 |     // Reset active category when view changes\n  51 |     useEffect(() => {\n> 52 |         setActiveCategory('all');\n     |         ^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  53 |     }, [currentView?.type, (currentView?.data as { slug?: string })?.slug]);\n  54 |\n  55 |     // 1. Resolve Taxonomy on Slug Change","line":52,"column":9,"nodeType":null,"endLine":52,"endColumn":26},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":53,"column":28,"nodeType":"ChainExpression","endLine":53,"endColumn":74},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2695,2698],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2695,2698],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2841,2844],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2841,2844],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2955,2958],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2955,2958],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":103,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":106,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4185,4188],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4185,4188],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":118,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5007,5010],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5007,5010],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5060,5063],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5060,5063],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7179,7182],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7179,7182],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'slugArray'. Either include it or remove the dependency array.","line":222,"column":8,"nodeType":"ArrayExpression","endLine":222,"endColumn":26,"suggestions":[{"desc":"Update the dependencies array to be: [params, slugArray, supabase]","fix":{"range":[9664,9682],"text":"[params, slugArray, supabase]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'targetId' is assigned a value but never used.","line":301,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":301,"endColumn":27},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":321,"column":95,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[13877,13926],"text":"The collection you are looking for doesn&apos;t exist."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[13877,13926],"text":"The collection you are looking for doesn&lsquo;t exist."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[13877,13926],"text":"The collection you are looking for doesn&#39;t exist."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[13877,13926],"text":"The collection you are looking for doesn&rsquo;t exist."},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":349,"column":21,"nodeType":"JSXOpeningElement","endLine":353,"endColumn":23}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useEffect, useState, useMemo } from 'react';\nimport Link from 'next/link';\nimport { useParams } from 'next/navigation';\nimport GlassCard from '@/components/UI/GlassCard';\nimport AmbientBackground from '@/components/UI/AmbientBackground';\nimport { motion } from 'framer-motion';\nimport { useUI } from '@/context/UIContext';\nimport ProductCard from '@/components/Product/ProductCard';\nimport { createClient } from '@/utils/supabase/client';\nimport { LayoutGrid, Filter } from 'lucide-react';\nimport BrandLoader from '@/components/UI/BrandLoader';\nimport TabbedProductShowcase from '@/components/Home/TabbedProductShowcase';\n\n// Strict Taxonomy Source\nimport { CATEGORY_TAXONOMY } from '@/data/categories';\nimport { getGoogleDriveDirectLink } from '@/utils/googleDrive';\nimport { TaxonomyCategory, DBProduct, ShopView, ShopProduct } from '@/types/shop';\n\nexport default function ShopClient() {\n    const { formatPrice } = useUI();\n    const params = useParams();\n    const rawSlug = params?.slug;\n    const slugArray = Array.isArray(rawSlug) ? rawSlug : rawSlug ? [rawSlug] : [];\n\n    // Derived State from Local Taxonomy\n    const [currentView, setCurrentView] = useState<ShopView | null>(null);\n    const [products, setProducts] = useState<ShopProduct[]>([]);\n    const [loadingProducts, setLoadingProducts] = useState(false);\n\n    // Derived State for Client-Side Category Filtering (Subcategory View)\n    const [activeCategory, setActiveCategory] = useState<string>('all');\n\n    // We need a map of Slug -> UUID for filtering.\n    const [categoryMap, setCategoryMap] = useState<Record<string, string>>({}); // Slug -> UUID\n\n    // Filter State\n    const [activeFilters, setActiveFilters] = useState({\n        minPrice: 0,\n        maxPrice: 10000,\n        colors: [] as string[],\n        sizes: [] as string[],\n        brands: [] as string[]\n    });\n    const [shopHeroConfig, setShopHeroConfig] = useState<Record<string, string>>({});\n\n    const supabase = useMemo(() => createClient(), []);\n\n    // Reset active category when view changes\n    useEffect(() => {\n        setActiveCategory('all');\n    }, [currentView?.type, (currentView?.data as { slug?: string })?.slug]);\n\n    // 1. Resolve Taxonomy on Slug Change\n    useEffect(() => {\n        const fetchShopConfigs = async () => {\n            try {\n                const { data, error } = await supabase\n                    .from('content_blocks')\n                    .select('section_id, content')\n                    .in('section_id', ['shop_page_collections', 'shop_hero_images']);\n\n                if (!error && data) {\n                    const collections = data.find((b: { section_id: string; content: any }) => b.section_id === 'shop_page_collections')?.content;\n                    const heroImages = data.find((b: { section_id: string; content: any }) => b.section_id === 'shop_hero_images')?.content;\n                    return { collections: collections as any[], heroImages: (heroImages || {}) as Record<string, string> };\n                }\n\n            } catch (err) {\n                console.error('Error fetching dynamic shop configs:', err);\n            }\n            return { collections: null, heroImages: {} };\n        };\n\n\n        // Helper to traverse\n        const resolve = async () => {\n            const { collections: dynamicCollections, heroImages } = await fetchShopConfigs();\n            setShopHeroConfig(heroImages);\n\n            // A. Root (/shop)\n            if (slugArray.length === 0) {\n                const children = dynamicCollections || Object.values(CATEGORY_TAXONOMY).map(c => ({\n                    id: c.id,\n                    name: c.name,\n                    image: c.image, // Ensure image exists in taxonomy\n                    slug: c.slug,\n                    description: c.description\n                }));\n\n                const rootHero = (heroImages as Record<string, string>)['root'] || 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=1600&q=80';\n\n                setCurrentView({\n                    type: 'root' as const,\n                    data: { name: 'Shop Worlds', description: 'Explore our curated collections.' } as any,\n                    children: children,\n                    breadcrumbs: [],\n                    heroImage: getGoogleDriveDirectLink(rootHero)\n                });\n\n                return;\n            }\n\n\n            const [l1Slug, l2Slug, l3Slug] = slugArray;\n\n            // B. Level 1 (e.g. kids-learning)\n            const l1Node = (Object.values(CATEGORY_TAXONOMY) as TaxonomyCategory[]).find(c => c.slug === l1Slug);\n            if (!l1Node) {\n                setCurrentView({ type: '404' as const, data: null, children: [], breadcrumbs: [] });\n                return;\n            }\n\n            if (slugArray.length === 1) {\n                // Special Case: Pets (Flattened Item Toggle)\n                if (l1Node.slug === 'pets') {\n                    const flattenedItems = l1Node.subcategories?.flatMap((sc: any) =>\n                        sc.items?.map((item: any) => ({\n                            id: item.slug,\n                            name: item.name,\n                            slug: `${l1Slug}/${sc.slug}/${item.slug}`,\n                            description: item.name // Simple desc\n                        })) || []\n                    ) || [];\n\n                    const categoryHero = (heroImages as Record<string, string>)[l1Node.slug] || l1Node.image;\n\n                    setCurrentView({\n                        type: 'category' as const,\n                        data: l1Node,\n                        children: flattenedItems.map(item => ({\n                            id: item.id,\n                            name: item.name,\n                            slug: item.slug,\n                            image: '', // Pets use root image\n                            description: item.description\n                        })),\n                        breadcrumbs: [{ label: l1Node.name, href: `/shop/${l1Node.slug}` }],\n                        heroImage: getGoogleDriveDirectLink(categoryHero)\n                    });\n\n                    return;\n                }\n\n                // Standard Category View\n                const categoryHero = (heroImages as Record<string, string>)[l1Node.slug] || l1Node.image;\n\n                setCurrentView({\n                    type: 'category' as const,\n                    data: l1Node,\n                    children: l1Node.subcategories?.map((sc) => ({\n                        id: sc.id,\n                        name: sc.name,\n                        slug: `${l1Slug}/${sc.slug}`, // Construct nested href\n                        image: sc.image || '', // Fallback if image not on sub\n                        description: sc.description || `Browse ${sc.name}`\n                    })) || [],\n                    breadcrumbs: [{ label: l1Node.name, href: `/shop/${l1Node.slug}` }],\n                    heroImage: getGoogleDriveDirectLink(categoryHero)\n                });\n\n                return;\n            }\n\n            // C. Level 2 (e.g. kids-learning/books)\n            const l2Node = l1Node.subcategories?.find((sc: any) => sc.slug === l2Slug);\n            if (!l2Node) {\n                setCurrentView({ type: '404' as const, data: null, children: [], breadcrumbs: [] });\n                return;\n            }\n\n            if (slugArray.length === 2) {\n                const subHeroLink = `${l1Node.slug}/${l2Node.slug}`;\n                const subHero = (heroImages as Record<string, string>)[subHeroLink] || (heroImages as Record<string, string>)[l1Node.slug] || l1Node.image;\n\n                setCurrentView({\n                    type: 'subcategory' as const,\n                    data: l2Node,\n                    children: l2Node.items?.map((item) => ({\n                        id: item.slug, // Use slug as ID for simple items\n                        name: item.name,\n                        slug: `${l1Slug}/${l2Slug}/${item.slug}`,\n                        image: '', // Leaf items don't have separate card images here\n                        description: `See all` // Simple desc\n                    })) || [],\n                    breadcrumbs: [\n                        { label: l1Node.name, href: `/shop/${l1Node.slug}` },\n                        { label: l2Node.name, href: `/shop/${l1Node.slug}/${l2Node.slug}` }\n                    ],\n                    heroImage: getGoogleDriveDirectLink(subHero)\n                });\n\n                return;\n            }\n\n            // D. Level 3 (e.g. kids-learning/books/story-books) -> Leaf (Products)\n            const l3Node = l2Node.items?.find((item) => item.slug === l3Slug);\n            if (!l3Node) {\n                setCurrentView({ type: '404' as const, data: null, children: [], breadcrumbs: [] });\n                return;\n            }\n\n            const subHeroLink = `${l1Node.slug}/${l2Node.slug}`;\n            const itemHero = (heroImages as Record<string, string>)[subHeroLink] || (heroImages as Record<string, string>)[l1Node.slug] || l1Node.image;\n\n            setCurrentView({\n                type: 'item' as const,\n                data: l3Node,\n                children: [], // No deeper levels\n                breadcrumbs: [\n                    { label: l1Node.name, href: `/shop/${l1Node.slug}` },\n                    { label: l2Node.name, href: `/shop/${l1Node.slug}/${l2Node.slug}` },\n                    { label: l3Node.name, href: `/shop/${l1Node.slug}/${l2Node.slug}/${l3Node.slug}` }\n                ],\n                heroImage: getGoogleDriveDirectLink(itemHero)\n            });\n\n        };\n\n        resolve();\n    }, [params, supabase]); // Recalculate when URL matches\n\n    // 2. Fetch Products if Leaf or Subcategory (Mixed View)\n    useEffect(() => {\n        const fetchProducts = async () => {\n            if (!currentView) return;\n            setLoadingProducts(true);\n\n            let targetSlugs: string[] = [];\n\n            if (currentView.type === 'item') {\n                targetSlugs = [((currentView.data as { slug?: string })?.slug) || ''];\n            } else if (currentView.type === 'subcategory' || (currentView.type === 'category' && (currentView.data as { slug?: string })?.slug === 'pets')) {\n                // For Pets (and standard Subcategories), use children IDs as targets\n                targetSlugs = currentView.children.map(c => c.id);\n            } else {\n                setLoadingProducts(false);\n                setProducts([]);\n                return;\n            }\n\n            if (targetSlugs.length > 0) {\n                // 1. Resolve Slugs to Category IDs AND Build Map\n                const { data: categories, error: catError } = await supabase\n                    .from('categories')\n                    .select('id, slug')\n                    .in('slug', targetSlugs);\n\n                if (catError) {\n                    console.error('Category Fetch Error:', catError);\n                    setLoadingProducts(false);\n                    return;\n                }\n\n                const newMap: Record<string, string> = {};\n                const categoryIds: string[] = [];\n\n                categories?.forEach((c: { id: string; slug: string }) => {\n                    newMap[c.slug] = c.id;\n                    categoryIds.push(c.id);\n                });\n                setCategoryMap(newMap);\n\n                if (categoryIds.length > 0) {\n                    const { data, error } = await supabase\n                        .from('products')\n                        .select('*')\n                        .in('category_id', categoryIds);\n\n                    if (error) {\n                        console.error('Fetch Error:', error);\n                    }\n                    const mapped: ShopProduct[] = (data || []).map((p: DBProduct) => ({\n                        id: p.id,\n                        name: p.name,\n                        brand: p.brand || 'BroncStudio',\n                        price: p.price,\n                        originalPrice: p.compare_at_price,\n                        image: p.images?.[0] || p.image_url || '/images/placeholder.jpg',\n                        secondaryImage: p.images?.[1],\n                        badge: p.stock_status === 'out_of_stock' ? 'Sold Out' : undefined\n                    }));\n                    setProducts(mapped);\n                } else {\n                    setProducts([]);\n                }\n            } else {\n                setProducts([]);\n            }\n            setLoadingProducts(false);\n        };\n\n        fetchProducts();\n    }, [currentView, supabase]);\n\n    // Enhanced Derived Filtered Products\n    const filteredProducts = products.filter(product => {\n        // 1. Active Category Filter\n        if (activeCategory !== 'all') {\n            const targetId = categoryMap[activeCategory];\n            // Since we don't have category_id on ShopProduct anymore, we'd need to add it or skip this check if filtered at DB\n            // However, ShopClient's activeCategory logic assumes we have it. \n            // For now, I'll let the DB filtering handle it and keep this as fallback.\n        }\n\n        // 2. Price\n        if (product.price < activeFilters.minPrice || product.price > activeFilters.maxPrice) return false;\n\n        // 3. Brand\n        if (activeFilters.brands.length > 0 && !activeFilters.brands.includes(product.brand || \"BroncStudio\")) return false;\n\n        return true;\n    });\n\n    if (currentView?.type === '404') {\n        return (\n            <div className=\"min-h-screen pt-[var(--header-height)] flex items-center justify-center bg-gray-50 dark:bg-navy-950\">\n                <div className=\"text-center\">\n                    <h2 className=\"text-3xl font-heading font-bold text-navy-900 dark:text-white mb-2\">Page Not Found</h2>\n                    <p className=\"text-gray-500 mb-6\">The collection you are looking for doesn't exist.</p>\n                    <Link href=\"/shop\" className=\"px-6 py-3 bg-navy-900 text-white rounded-full font-bold hover:bg-coral-500 transition-all\">\n                        Return to Shop\n                    </Link>\n                </div>\n            </div>\n        );\n    }\n\n    if (!currentView) return <BrandLoader text=\"Curating Collection...\" />;\n\n    // ONLY Show \"Cards\" for Root. Subcategory (and Pets) now shows Products.\n    const showChildren = currentView.type === 'root';\n    const showProducts = currentView.type === 'item' || currentView.type === 'subcategory' || (currentView.type === 'category' && (currentView.data as { slug?: string })?.slug === 'pets');\n\n    // Dynamic Gradient based on type\n    const heroGradient = currentView.type === 'root'\n        ? 'from-blue-500/10 via-purple-500/5 to-coral-500/10'\n        : 'from-emerald-500/10 via-teal-500/5 to-blue-500/10';\n\n    return (\n        <div className=\"relative min-h-screen bg-background pt-[220px] -mt-[120px] pb-20 overflow-hidden\">\n            <AmbientBackground />\n\n            {/* HERO BANNER IMAGE (If Available) */}\n            {currentView.heroImage && (\n                <div className=\"absolute top-0 left-0 right-0 h-[400px] md:h-[500px] z-0\">\n                    <div className=\"absolute inset-0 bg-black/40 z-10\" />\n                    <img\n                        src={currentView.heroImage}\n                        alt=\"Collection Hero\"\n                        className=\"w-full h-full object-cover\"\n                    />\n                    <div className=\"absolute inset-0 bg-gradient-to-t from-gray-50 dark:from-black to-transparent z-20\" />\n                </div>\n            )}\n\n\n            {/* Background Blob */}\n            <div className={`absolute top-0 left-0 right-0 h-[500px] bg-gradient-to-br ${heroGradient} ${currentView.heroImage ? 'opacity-20' : 'opacity-40'} blur-3xl pointer-events-none z-0`} />\n\n            {/* Breadcrumbs */}\n            <div className=\"relative z-40 px-6 py-4 mt-8\">\n                <div className=\"max-w-fit mx-auto px-6 py-2 bg-white/50 dark:bg-black/50 backdrop-blur-xl rounded-full border border-white/20 dark:border-white/5 flex items-center space-x-2 text-xs font-bold uppercase tracking-wider text-secondary shadow-sm\">\n                    <Link href=\"/\" className=\"hover:text-coral-500 transition-colors\">Home</Link>\n                    <span className=\"opacity-40\">/</span>\n                    <Link href=\"/shop\" className=\"hover:text-coral-500 transition-colors\">Shop</Link>\n                    {currentView.breadcrumbs.map((crumb, idx) => (\n                        <React.Fragment key={idx}>\n                            <span className=\"opacity-40\">/</span>\n                            <Link href={crumb.href} className={idx === currentView.breadcrumbs.length - 1 ? \"text-coral-500\" : \"hover:text-coral-500 transition-colors\"}>\n                                {crumb.label}\n                            </Link>\n                        </React.Fragment>\n                    ))}\n                </div>\n            </div>\n\n            {/* Hero Title & Tagline */}\n            <div className=\"relative z-30 max-w-[1400px] mx-auto px-6 pt-4 pb-12 text-center\">\n                <motion.h1\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    className=\"text-4xl md:text-6xl font-heading font-bold text-white mb-4 drop-shadow-lg\"\n                >\n                    {(currentView.data as { name: string })?.name}\n                </motion.h1>\n                <motion.p\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    transition={{ delay: 0.1 }}\n                    className=\"text-lg md:text-xl text-white/90 font-medium max-w-2xl mx-auto drop-shadow-md\"\n                >\n                    {(currentView.data as { description?: string })?.description}\n                </motion.p>\n            </div>\n\n            {/* Conditional Layout */}\n            {currentView.type === 'category' && (currentView.data as { slug?: string })?.slug !== 'pets' ? (\n                <div className=\"-mt-12\">\n                    <TabbedProductShowcase categorySlug={(currentView.data as { slug?: string })?.slug || ''} />\n                </div>\n            ) : (\n                <div className=\"relative z-10 max-w-[1400px] mx-auto px-4 md:px-8\">\n                    {showChildren && (\n                        <motion.div\n                            initial={{ opacity: 0 }}\n                            animate={{ opacity: 1 }}\n                            className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mb-20\"\n                        >\n                            {currentView.children.map((child, idx) => (\n                                <Link key={idx} href={`/shop/${child.slug}`} className=\"group relative block h-full\">\n                                    <GlassCard className=\"relative h-full min-h-[400px] flex flex-col justify-end overflow-hidden rounded-[2rem] bg-transparent hover:border-white/50 transition-all duration-500\" disableTilt>\n                                        <div className=\"absolute inset-0 bg-cover bg-center\" style={{ backgroundImage: `url(${getGoogleDriveDirectLink(child.image) || '/images/placeholder.jpg'})` }} />\n                                        <div className=\"absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-60\" />\n                                        <div className=\"relative z-10 p-8\">\n                                            <h3 className=\"text-3xl font-heading font-bold text-white mb-2\">{child.name}</h3>\n                                            <p className=\"text-sm text-white/80 line-clamp-2\">{child.description}</p>\n                                        </div>\n                                    </GlassCard>\n                                </Link>\n                            ))}\n                        </motion.div>\n                    )}\n\n                    {showProducts && (\n                        <div className=\"flex flex-col lg:flex-row gap-8 items-start\">\n                            <aside className=\"hidden lg:block w-[280px] flex-shrink-0 sticky top-32\">\n                                {(currentView.type === 'subcategory' || currentView.type === 'category') && (\n                                    <div className=\"bg-white/40 dark:bg-card/40 backdrop-blur-md rounded-2xl p-6 border border-white/20\">\n                                        <h3 className=\"text-sm font-bold uppercase tracking-wider text-secondary mb-4\">Categories</h3>\n                                        <div className=\"flex flex-col space-y-2\">\n                                            <button onClick={() => setActiveCategory('all')} className={`text-left text-lg font-heading font-bold ${activeCategory === 'all' ? 'text-coral-500' : 'text-primary'}`}>All Products</button>\n                                            {currentView.children.map((child, idx) => (\n                                                <button key={idx} onClick={() => setActiveCategory(child.id)} className={`text-left text-lg font-heading font-bold ${activeCategory === child.id ? 'text-coral-500' : 'text-primary'}`}>{child.name}</button>\n                                            ))}\n                                        </div>\n                                    </div>\n                                )}\n                            </aside>\n\n                            <div className=\"flex-1 w-full\">\n                                {loadingProducts ? (\n                                    <div className=\"flex justify-center py-20\"><BrandLoader text=\"Loading...\" /></div>\n                                ) : filteredProducts.length > 0 ? (\n                                    <div className=\"grid grid-cols-2 md:grid-cols-3 gap-8\">\n                                        {filteredProducts.map((p) => (\n                                            <ProductCard key={p.id} {...p} />\n                                        ))}\n                                    </div>\n                                ) : (\n                                    <div className=\"py-20 text-center\"><h3 className=\"text-xl font-bold\">No products found</h3></div>\n                                )}\n                            </div>\n                        </div>\n                    )}\n                </div>\n            )}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/dhanushj/Desktop/Broncstudio/src/components/Home/TabbedProductShowcase.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
